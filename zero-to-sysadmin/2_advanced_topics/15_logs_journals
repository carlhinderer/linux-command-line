-----------------------------------------------------------
CHAPTER 15 - LOGS & JOURNALS
-----------------------------------------------------------

- Logs Are Your Friend

    - Log files help determine the source of problems and performance issues.  They contain 
        large amounts of data.  The biggest troubleshooting mistake is not going to logs
        sooner.


    - In general and by default, log files are maintained for a period of 1 month, with each
        log containing a maximum of 1 week of data.

      If the amount of data passes a predefined threshold, the file may be rotated at that time.
        The 'logrotate' facility manages log rotation and deletion.



- SAR (System Activity Report)

    - The SAR is a good place to start when looking for information about a Linux machine's
        performance and performance-related problems.


    - The SAR files are in a binary format and cannot be read directly.  The 'sar' command is used
        to view them.

        # Install sar if not already installed
        $ dnf -y install sysstat

        # Enable and start sar
        $ systemctl enable sysstat
        $ systemctl start sysstat

    
    - Now, we can view the reports:

        # Display performance summaries in 10-minute intervals
        $ sar | head -25

        # The -A flag will display all data collected by sar
        $ sar -A | less


    - We can also look at an entire day's file

        # List sar files
        $ ls /var/log/sa

        # View a particular day's logs
        $ sar -A -f sa07 | less



- logrotate

    - The 'logrotate' is designed to remove logs after an interval so that disk space does 
        not fill up.  It accomplishes this by rotating logs on a regular basis.  This can
        be triggered by time parameters or by log file size.


    - The maximum number of old log files to keep is defined in the config file for each
        service.  The config for logrotate itself is stored in /etc/logrotate.conf.

        # View logrotate configuration
        $ cat /etc/logrotate.conf

        /var/log/cron
        /var/log/maillog
        /var/log/messages
        /var/log/secure
        /var/log/spooler
        {
            missingok
            sharedscripts
            postrotate
                /usr/bin/systemctl kill -s HUP rsyslog.service >/dev/null 2>&1 || true
            endscript
        }


    - The file contains the list of logs for which this configuration covers, followed by a 
        list of directives for the configuration:

        Directive                  Purpose
        --------------------------------------------------------------------------------------
        missingok                  Just ignore and don't error if log files are missing

        sharedscripts              Use same directives for all scripts listed

        postrotate                 Specify script to run after log files are rotated

        endscript                  Defines the end of the script

        create mode owner group    Specifies mode and ownership of new log files

        nocreate                   Prevents new logs from being created

        compress                   Specifies whether to compress old log files

        delaycompress              Delays compression of newly rotated log files

        notifyempty                Do not rotate log file if empty

        rotate X                   Defines number of old log files to keep

        size Y                     Defines when to rotate based on log size       

        hourly daily weekly        Define intervals on which to rotate the logs
        monthly yearly



- messages

    - The /var/log/messages files contain kernel and other system-level messages.  They are
        frequently useful when troubleshooting problems.  They are more informational and
        not normally performance-related.

        # View all messages
        $ less /var/log/messages


    - Entries from the kernel, systemd, the DHCP client, and many of the running services are
        logged here.  Messages include:

        - User logins and logouts
        - DHCP client requests
        - The resulting DHCP configuration
        - Data logged by systemd during startup and shutdown
        - Kernel data about things like USB devices when plugged in
        - USB hub information



- Mail Logs

    - If we have a mail server, we will need to use logs to solve problems related to 
        non-delivery or blocking of email messages, spam filters, etc.  There are log 
        entries in /var/log/maillog that provide this information.

        # List mail logs
        $ ls /var/log/mail*



- dmesg

    - 'dmesg' is a commmand, not a log file.  At one time, it was a log file at /var/log/dmesg
        that contained all the messages generated by the kernel during startup.

      Now, it displays data about the boot process and hardware information, much of which is
        found in the /proc filesystem and udev logs.


      # View boot and hardware messages
      $ dmesg | less



- secure

    - The /var/log/secure log file contains security-related entries.  This includes 
        information about successful and unsuccessful login attempts.

        # View security messages
        $ less /var/log/secure



- Following Log Files

    - The 'tail -f' command can be used to continuously view the end of a file.

        # Follow log messages as they are added
        $ tail -f /var/log/messages


    - We can add some log entries to test this:

        # Add a new entry to the messages file
        $ logger "This is test message 1."

        # This will work also
        $ echo "This is test message 2." | logger



- systemd Journals

    - systemd has its own set of logs (aka journals) which replace the traditional ASCII text
        files found in /var/log.  The 'journalctl' command is used to view and manipulate
        the systemd logs.

        # View all systemd messages, piped through less
        $ journalctl


    - There are various filters that can be used to make the output more specific:

        # View messages by date
        $ journalctl --since 2017-12-20 --until 2017-12-24

        # Fuzzy dates can also be used
        $ journalctl --since yesterday


        # List all system boots
        $ journalctl --list-boots

        # View messages by unique boot id
        $ journalctl -b  d62a1f3edd144e4fbf54b3b3b2f90785

        # View messages from the 8th most recent boot
        $ journalctl -b 8



- logwatch

    - Searching through a large number of log files is time-consuming and cumbersome, even with
        tools like 'grep' and 'tail'.  logwatch is a tool that can analyze the system log files
        and detect anomalous entries that the SysAdmin should look at.

      By default, it runs at 3:30 AM each day and emails results to the root account.  This can
        be changed in the config file /usr/share/logwatch.


        # Install logwatch
        $ dnf -y install logwatch

        # Get logwatch results with the most possible detail
        $ logwatch --detail 10 | less

        # Get systemd results with high detail
        $ logwatch --service systemd --detail high | less