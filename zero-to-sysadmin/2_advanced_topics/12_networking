-----------------------------------------------------------
CHAPTER 12 - NETWORKING
-----------------------------------------------------------

- Basic Networking Concepts

    - This book uses primarily IPv4, since it is still much more common on hosts.  Many
        ISP's use IPv6 for their backbones.


    - Basic Definitions

        1. A 'node' is any device connected to and acessible on a network, including computers,
             routers, printers, etc.

        2. A 'host' is a node that is a computer attached to the network.

        3. The 'Internet Protocol' allows computers to communicate.  IP is a best-effort, packet
             switching protocol used to transmit data packets from one network node to another.
             It is not reliable since packets can be lost or dropped for a number of reasons.

        4. The 'Transmission Control Protocol' sits on top of IP.  It provides reliable communications
             and flow control, including full duplex (communications can go in both directions
             at the same time).

        5. A 'network' is a web-like (or net-like) structure of communications system that allows
             connected nodes to communicate with each other.


    - Network Definitions

        1. A 'NIC' is a network interface controller that is either built into a computer 
             motherboard or added as a pluggable device card.

        2. A 'network node' is any device connected to a network and is addressable by other
             devices such that a connection can be made.

        3. A 'switch' is a hardware device used to connect multiple nodes together on a logical
             network segment.  The switch is connected to each node with an Ethernet cable.
             They are physical-layer devices only.

        4. A 'router' is a device that routes data packets between 2 or more networks based on the
             destination IP address contained in the data packets.  Routers have IP addresses 
             for each network to which they connect, and are visible to other devices on the
             network.

        5. At least one router on the network is the 'default gateway' to other networks or the
             rest of the internet.  If a data packet is sent by a host and there are no other routes
             defined, the default gateway sends the pacekt to the next router on the way to its
             final destination.

        6. A 'connection' is a logical link between 2 nodes on a network.  Connections exist at
             each layer of the TCP/IP stack.



- MAC Addresses

    - A 'MAC address' is a unique hardware address assigned to each NIC that provides the
        hardware as a means of identification.  They are hard-coded by the manufacturer,
        but they can be spoofed in software.


    - MAC addresses consist of 6 2-digit hex numbers, separated by colons.  The first 3
        numbers identify the vendor, and last 3 are specific for that vendor.

        08:00:27:81:ec:cc


    - We can use the 'ip addr' command to see installed NICs with their MAC and IP addresses.

        # Get NIC information
        $ ip addr

        1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
            link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
            inet 127.0.0.1/8 scope host lo
               valid_lft forever preferred_lft forever
            inet6 ::1/128 scope host
               valid_lft forever preferred_lft forever
        2: enp0s3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
            link/ether 08:00:27:e1:0c:10 brd ff:ff:ff:ff:ff:ff
            inet 10.0.2.7/24 brd 10.0.2.255 scope global dynamic noprefixroute enp0s3
               valid_lft 1057sec preferred_lft 1057sec
            inet6 fe80::b7f2:97cf:36d2:b13e/64 scope link noprefixroute
               valid_lft forever preferred_lft forever

        The first entry is the local interface (lo) which is used by many Linux tasks and 
          applications to communicate within the host.

        The second entry, 'enp0s3', is how Linux sees the first virtual network adapter on a 
          VirtualBox VM.  


    - All networked devices have a MAC address, and the 'ip' command enables us to see
        the MAC and IP addresses of the 'neighbor' hosts with which we have communicated.

        # List neighbors
        $ ip neigh
        10.0.2.1 dev enp0s3 lladdr 52:54:00:12:35:00 REACHABLE

        # If nothing comes up, force communication with the router/gateway and try again
        $ ping -c2 _gateway ; ip neigh

        The result we get is the virtual router in our virtual network.  


    - We can also use the 'arp' command to view the MAC addresses.

        # Display devices by DNS name
        $ arp

        # Display devices by IP address
        $ arp -n


    - The 'ip' command is designed to replace ifconfig, arp, and some other network commands.
        For now, these other commands are still available (and probably will be for years).



- IP Addresses

    - An IPv4 address is 4 octets (32 bits total).

        255.255.255.0
        10.0.2.7


    - An IPv6 address is 8 sections of 4 hex digits (128 bits total).

        # Long version
        2001:0db8:0000:0000:0000:ff00:0042:8329

        # Short version (with leading zeros and consecutive sections of zeros omitted)
        2001:db8::ff00:42:8329


    - The loopback IPv4 address is 127.0.0.1 (::1/128 in IPv6).  We can ping both addresses.
        The ping command sends a special ICMP data packet to the target IP address

        # Ping ipv6 localhost
        $ ping -c2 ::1

        # Ping ipv4 localhost
        $ ping -c2 127.0.0.1

        # Note that we can also ping remote hosts
        $ ping -c2 www.example.com


    - The IANA (Internet Assigned Numbers Authority) is responsible for global coordination
        and management of IP addresses.  The organization coordinates the assignment of
        blocks of addresses to large geographic-political entities.  These entities assign
        them to customers like ISPs.



- TCP/IP

    - TCP/IP Network Model


                          | Host1 |-------->| Router |--------->| Host2 | 
                               |                                    ^
        Protocols              v                                    |
         HTTP, SSH,       | Application |                     | Application |
         SMTP, POP, IMAP,      |                                    ^
         etc.                  |                                    |
                               v                                    |
         TCP and UDP      | Transport |                       | Transport |
                               |                                    ^
                               v                                    |
         IP               | Internet |    | Internet |        | Internet |
                               |             ^   |                  ^
                               v             |   v                  |       
         Ethernet         | Datalink |    | Datalink |        | Datalink |
                               |             ^   |                  ^
                               v             |   v                  |
         Fiber, copper,   | Physical |--->| Physical |------->| Physical |
         NIC, etc.



    - Layers

        1. Application layer - Message

        2. Transport layer - TCP Segment

        3. Internet layer - Packet

        4. Data link layer - Frame

        5. Physical layer - Bits



- Simple TCP/IP Example

        1. In the application layer, web browser sends an HTTP message to the remote host, 
             www.example.com, to send back the web page data.


        2. The transport layer encapsulates the message in a TCP datagram with the IP 
             address of the remote web server as the destination.  

           Along with the usual request packet, this packet now includes the source port from 
             which the request will originate (usually a very high number random port) so 
             that the return data knows which port the browser is listening on.  It also
             includes the destination port on the remote host (80).


        3. The internet layer encapsulates the TCP datagram in a packet that also contains the
             internet packet in a frame that includes both the source and destination IP
             addresses.


        4. The data link layer uses the ARP (Address Resolution Protocol) to identify the physical
             MAC address of the default router and encapsulates the internet packet in a frame
             that includes both the source and destination MAC addresses.


        5. The frame is sent over the wire (CAT5 or CAT6).  If a wireless NIC is communicating
             with a wireless router, the wireless router is the default (gateway) router.


        6. The default router opens the datagram and determines the destination IP address.  The
             router uses its own routing table to determine the IP address of the next router 
             that will take the frame on the next step of its journey.  

           The router then re-encapsulates the frame in a new datagram that contains its own MAC
             as the source and MAC of the next router as its destination.  


        - Routers perform their routing tasks at Layer 3.  Switches are invisble to all protocols
            at Layers 2 and above, so they do not affect the transmission of the data in any 
            logical way.  

          The function of a switch is only to provide a simple means to connect multiple hosts into
            a single physical network via ethernet cables.



- CIDR - Network Notation and Configuration

    - CIDR (Classless Inter-Domain Routing) defines a notation methodology for network addressing
        used to specify the network portion of an IP address.


    - Network Classes

      Class  Start       End               Subnet Mask     CIDR   # of Networks    IP Addrs/Network
      ----------------------------------------------------------------------------------------------
      A      0.0.0.0     127.255.255.255   255.0.0.0       /8     128              16,177,216
      B      128.0.0.0   191.255.255.255   255.255.0.0     /16    16,384           65,536
      C      192.0.0.0   223.255.255.255   255.255.255.0   /24    2,097,152        256
      D      224.0.0.0   239.255.255.255                          Undefined        Undefined
      E      240.0.0.0   255.255.255.255                          Undefined        Undefined


    - Network Class Details

        - Class A, B, and C are unicast address ranges (packets are sent to a single host).  

          Class D is multicast (packets are sent to all hosts on a defined network), and is essentially
            unused.

          Class E was reserved for future expansion but was never used.


        - In the early years of the internet, addresses were doled out in wasteful ways, with
            Class C-sized orgs getting B addresses and Class B-sized orgs getting A addresses.
            Thus, a few orgs were assigned very large number of addresses.


        - The class of a network is defined by the first 4 bits of the address, not the subnet mask
            (or the CIDR equivalent of the subnet mask).  This meant that large networks could 
            not be broken down into smaller networks, because routing tables in routers only have
            one entry per network.


        - The 'sipcalc' program provides a lot of information about network classes.

            # Install sipcalc
            $ dnf -y install sipcalc

            # Provide network data for a class B network
            $ sipcalc 10.125.0.0/16



    - Along Came a CIDR

        - CIDR notation (1993) was introduced as a means of extending the IPv4 address space,
            which was rapidly running out of addresses.

          It accomplishes this by making it possible for orgs to more efficiently use the public
            IPv4 address ranges by opening up some previously reserved ranges.


        - Basically, it introduced ranges of private addresses, which any org can use freely
            inside their internal network.  Therefore, it is no longer necessary for every 
            computer to have an assigned public IP address.  Of course, the private IP 
            addresses can communicate inside of an internal network.


            CIDR Block         Address Range                    # of IP Addresses
            -----------------------------------------------------------------------
            10.0.0.0/8         10.0.0.0 - 10.255.255.255        16,777,216
            172.16.0.0/12      172.16.0.0 - 172.31.255.255      1,048,576
            192.168.0.0/16     192.168.0.0 - 192.168.255.255    65,536


        - We can see how many addresses each network can assign, based on the number of bits
            in the CIDR.

            # Only 2 bits available for host
            $ sipcalc 10.125.16.32/30

            -[IPv4 : 10.125.16.32/30] - 0
            [CIDR]
            Host address            - 10.125.16.32
            Host address (decimal)  - 175968288
            Host address (hex)      - A7D1020
            Network address         - 10.125.16.32
            Network mask            - 255.255.255.252
            Network mask (bits)     - 30
            Network mask (hex)      - FFFFFFFC
            Broadcast address       - 10.125.16.35
            Cisco wildcard          - 0.0.0.3
            Addresses in network    - 4
            Network range           - 10.125.16.32 - 10.125.16.35
            Usable range            - 10.125.16.33 - 10.125.16.34


            # 20 bits available for host
            $ ~]$ sipcalc 172.16.0.0/12

            -[IPv4 : 172.16.0.0/12] - 0
            [CIDR]
            Host address            - 172.16.0.0
            Host address (decimal)  - 2886729728
            Host address (hex)      - AC100000
            Network address         - 172.16.0.0
            Network mask            - 255.240.0.0
            Network mask (bits)     - 12
            Network mask (hex)      - FFF00000
            Broadcast address       - 172.31.255.255
            Cisco wildcard          - 0.15.255.255
            Addresses in network    - 1048576
            Network range           - 172.16.0.0 - 172.31.255.255
            Usable range            - 172.16.0.1 - 172.31.255.254



    - Variable Length Subnet Masking

        - CIDR brings a new approach to the old netmask, called VLSM (Variable Length Subnet
            Masking), that lets orgs create more managable subnets from the private address
            space.


        - For instance, say we want to take the private space available in:

            172.16.0.0/12

          We can split this space into 16 equal sized subnets:

            # Split address space into subnets
            $ sipcalc 172.16.0.0/12 -s 16

            -[IPv4 : 172.16.0.0/12] - 0
            [Split network]
            Network                 - 172.16.0.0      - 172.16.255.255
            Network                 - 172.17.0.0      - 172.17.255.255
            Network                 - 172.18.0.0      - 172.18.255.255
            Network                 - 172.19.0.0      - 172.19.255.255
            Network                 - 172.20.0.0      - 172.20.255.255
            Network                 - 172.21.0.0      - 172.21.255.255
            Network                 - 172.22.0.0      - 172.22.255.255
            Network                 - 172.23.0.0      - 172.23.255.255
            Network                 - 172.24.0.0      - 172.24.255.255
            Network                 - 172.25.0.0      - 172.25.255.255
            Network                 - 172.26.0.0      - 172.26.255.255
            Network                 - 172.27.0.0      - 172.27.255.255
            Network                 - 172.28.0.0      - 172.28.255.255
            Network                 - 172.29.0.0      - 172.29.255.255
            Network                 - 172.30.0.0      - 172.30.255.255
            Network                 - 172.31.0.0      - 172.31.255.255



- DHCP Client Configuration



- NIC Naming Conventions



- NIC Configuration Files

    - Create an Interface Configuration File



- The Interface Configuration File

    - The Network File
    - The Route-<Interface> File
    - Other Network Files



- Network Startup

    - The NetworkManager Service



- Name Services

    - How a Name Search Works
    - Using the /etc/hosts File



- Introduction to Network Routing

    - The Routing Table



- iptraf-ng



- Cleanup
