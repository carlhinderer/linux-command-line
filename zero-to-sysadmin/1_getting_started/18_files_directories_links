-----------------------------------------------------------
CHAPTER 18 - FILES, DIRECTORIES, & LINKS
-----------------------------------------------------------

- Files

    - A 'file' is a unit of storage consisting of a single sequence of data with a finite
        length that is stored on nonvolatile storage medium.

    - Files are stored in directories and are accessed using a file name and an optional
        path.  Files also support various attributes such as permissions and timestamps
        for creation, last modification, and last access.



- Preparation

    - Here, we'll set up some files for the exercises in this chapter:

        # Create some files
        $ cd ~/Documents
        $ for I in `seq -w 20` ; do dmesg > testfile$I ; touch test$I file$I ; done


           `seq -w 20`     

               - 'seq' prints a sequence of numbers (0 to 20 in this case)

               - `` around the command cause the results to be expanded into a list that can 
                   be used by the 'for' command

               - '-w' option specifies that all numbers will have the same length (smaller
                   numbers are padded with zeros)


        # Now we can see the files we created
        $ ll -h


    - Now, we'll create a new user for testing also:

        # Create new user
        $ useradd -c "Student user 1" student1

        # Set the pw for the new user
        $ passwd student1



- User Accounts and Security

    - User accounts are the first line of security on your Linux computer.  The security of 
        the computer and the data stored there are based on the user accounts created by the 
        Linux SysAdmin or by some form of centralized authorization system.

    - A user cannot access any resources on a Linux system without loggin on with an account
        ID and password.

    - Each file and directory on a Linux system has an owner and a set of access permissions.
        Setting the ownership and permissions correctly allows user to access the files that
        belong to them, but not files belonging to others.



- File Attributes

    - File Ownership

        - File ownership is one of the attributes that is part of Linux file security protocols:

            -rw-rw-r--  1  student  student  44K  Dec  4  09:47  testfile09


        - There are 2 owners associated with every file, the User who owns the file, and the
            Group ownership.  

          The user who created the file is always the owner of the file, unless it is changed.

          In RedHat-based distros, each user has their own private group and files created by
            them also belong to that group.  This 'RedHat private group' method is used to 
            improve security.  In many older distros, all users are added to a common group
            (group 100), and thus all the files created belonged to that group.


        - Here, we change the user and group ownerships of one of our test files as the
            student user:

            # Look at one of our test files
            $ ll file09

            # Try to change user ownership
            $ chown student1 file09
            chown: changing ownership of 'file09': Operation not permitted

            # Try to change group ownership
            $ chgrp student1 file09
            chgrp: changing group of 'file09': Operation not permitted


        - As we can see, the user cannot change the file's user and group ownerships.  But
            what if we want to share the file with another user?  One way is to copy the
            file to /tmp.

            # First, add some data to our file
            $ echo "Hello world." > file09
            $ cat file09

            # Now, copy the file to /tmp
            $ cp file09 /tmp


            # Now, open a new terminal tab and switch to the new user
            $ su - student1

            # We can view the file
            $ cat /tmp/file09

            # And we can copy the file to the new user's home directory
            $ cp /tmp/file09 . ; cat file09


    - File Permissions

        - The file permissions (aka the 'file mode'), along with the file ownership, provide
            a means of defining which users and groups have access to specific files and
            directories.  


        - The User permissions define the access rights of the user who owns the file.  The
            Group permissions define the access rights of the group that owns the file.
            The Other permissions defines what everyone else can do.

                             User       Group        Other
            -------------------------------------------------------
            Permissions      r w x      r w x        r w x
            Bits             1 1 1      1 1 1        1 1 1
            Octal value      4 2 1      4 2 1        4 2 1


        - In our previous example, since Other has read permissions, the 'student1' user was
            able to copy the file from /tmp to their home directory.

          Here, we change the permissions so that Other cannot read the file:

            # Change the permissions
            $ su - student
            $ cd /tmp
            $ chmod 660 file09

            # Now the student1 user cannot read the file
            $ su - student1
            $ cat /tmp/file09


    - Directory Permissions

        - Directory permissions are similar to file permissions:

            1. The read permission on a directory allows access to list the content of the
                 directory.

            2. The write permission allows users of a class to create, change, and delete
                 files in the directory.

            3. The execute permission allows the users of a class to make the directory 
                 the PWD.


    - Implications of Group Ownership

        - We still need a way for users to share files with some users, but not all users.
            This is where Linux groups shine - they allow sharing of files in a secure way.

          A 'group' is an entity defined in the /etc/group file that lists the user IDs of the
            members of the group.  


        - To create a group and add some users:

            # Create another new user
            $ su -
            $ useradd -c "Student User 2" student2
            $ passwd student2


            # Create a group
            $ groupadd -g 5000 dev

            # Add 2 of the users to the group
            $ usermod -G 5000 student
            $ usermod -G 5000 student1


            # The 'gpasswd' command can be also be used to add multiple users
            $ gpasswd -M student,student1 dev


            # Look at the last 10 lines of /etc/groups
            $ tail /etc/group

            vboxsf:x:981:
            dnsmasq:x:980:
            tcpdump:x:72:
            student:x:1000:
            screen:x:84:
            systemd-timesync:x:979:
            dictd:x:978:
            student1:x:1001:
            student2:x:1002:
            dev:x:5000:student,student1


        - Now, as the root user, create the shared directory /home/dev, and set the group
            ownership to dev and the permissions to 770, which will prevent users who aren't in
            the group from accessing the directory.

            # Create the new directory
            $ cd /home ; mkdir dev

            # Set the group ownership
            $ chgrp dev dev

            # Change the permissions
            $ chmod 770 dev


        - Since the /etc/groups file is read when the login shell is started, we'll need
            to restart the shell to see our changes reflected.  

          Now, as the 'student' user, create a file in the /home/dev directory and change the
            group ownership and permissions of the file.

            # Create new file
            $ cd /home/dev
            $ echo "Hello World" > file01

            # Change the group ownership
            $ chgrp dev file01


            # Now, the other users in the group can edit the file also
            $ su - student1
            $ cd ../dev
            $ echo "Hello to you, too" >> file01


        - There is one last thing we can do for convenience.  When we created the new file in
            the /dev directory, it had the group ID that belonged to the user that created it,
            but we changed it to the 'dev' group.

          We can add the setgid (Set Group ID) bit on the directory, which informs Linux to 
            create files in the /dev directory with the same group ID as the directory.

            # Set the setgid bit on the directory
            $ su -
            $ cd /home
            $ chmod g+s dev

            # If we wanted to use octal instead
            $ chmod 2770 dev


    - umask
    - Changing File Permissions
    - Applying Permissions
    - Timestamps


- File Meta-Structures

    - The Directory Entry
    - The inode


- File Information


- Links

    - Hard Links
    - Locating Files with Several Hard Links
    - Symbolic Links